---
import "photoswipe/style.css"
import Layout from "@/layouts/Layout.astro"
import { api } from "@/lib/api"
import Map from "@/components/map"
import HeartButton from "@/components/HeartButton"

const { id } = Astro.params
if (!id) {
	throw new Error("No property ID provided")
}
const property = await api.getProperty(id)
const propertyPhotos =
	property?.photos
		?.map((photo: any) => ({
			fields: {
				file: { url: photo?.fields?.file?.url || "" },
			},
		}))
		.filter((photo) => photo.fields.file.url) || []

while (propertyPhotos.length < 5) {
	const lastElement = propertyPhotos[propertyPhotos.length - 2]
	propertyPhotos.push(lastElement)
}

const formattedPrice = property?.price
	? property.price
			.toLocaleString("en-US", { style: "currency", currency: "USD" })
			.replace(".00", "")
	: "Consultar precio"
---

<Layout
	title={`${property!.title} | Inmobiliaria`}
	description={property?.description || "Descubri esta increible propiedad en nuestra inmobiliaria"}
>
	<section class="mx-auto max-w-[1760px] px-6 py-6 md:px-10 lg:px-20">
		<div class="mb-6 flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
			<h1 class="text-2xl font-semibold leading-tight text-airbnb-gray-500 md:text-[26px]">
				{property?.title}
			</h1>
			<div class="flex items-center gap-4">
				<button
					class="flex items-center gap-2 rounded-lg px-3 py-2 text-sm font-medium text-airbnb-gray-500 transition-colors hover:bg-airbnb-gray-50"
				>
					<svg
						xmlns="http://www.w3.org/2000/svg"
						viewBox="0 0 24 24"
						fill="none"
						stroke="currentColor"
						stroke-width="2"
						stroke-linecap="round"
						stroke-linejoin="round"
						class="size-4"
					>
						<path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline
							points="16 6 12 2 8 6"></polyline><line x1="12" x2="12" y1="2" y2="15"></line>
					</svg>
					<span class="underline">Compartir</span>
				</button>
				<div
					class="flex cursor-pointer items-center gap-2 rounded-lg px-3 py-2 text-sm font-medium text-airbnb-gray-500 transition-colors hover:bg-airbnb-gray-50"
				>
					<HeartButton propertyId={id} client:load />
					<span class="underline">Guardar</span>
				</div>
			</div>
		</div>

		<section class="-mx-6 mb-8 md:mx-0">
			<div
				class="relative flex w-full snap-x snap-mandatory gap-0 overflow-x-auto scroll-smooth md:hidden"
			>
				{
					propertyPhotos.map((propertyImg, index) => (
						<div class="relative w-full flex-none shrink-0">
							<img
								src={`${propertyImg.fields.file.url}`}
								alt={`Foto ${index + 1} de ${property?.title}`}
								class="h-[300px] w-full snap-center object-cover"
								transition:name={index === 0 ? `property-image-${id}` : undefined}
							/>
							<div class="absolute bottom-4 right-4 rounded-full bg-black/70 px-3 py-1 text-sm font-medium text-white">
								{index + 1}/{propertyPhotos.length}
							</div>
						</div>
					))
				}
			</div>

			<div class="relative hidden md:block">
				<div
					class="grid max-h-[500px] grid-cols-4 grid-rows-2 gap-2 overflow-hidden rounded-xl"
					id="gallery"
				>
					{
						propertyPhotos.slice(0, 5).map((propertyImg, index) => {
							const isMain = index === 0
							return (
								<a
									href={`${propertyImg.fields.file.url}`}
									class:list={[
										"group relative overflow-hidden",
										isMain ? "col-span-2 row-span-2" : "",
									]}
									target="_blank"
								>
									<img
										src={`${propertyImg.fields.file.url}`}
										alt={`Foto ${index + 1} de ${property?.title}`}
										class="size-full object-cover transition-all duration-300 group-hover:scale-105 group-hover:brightness-90"
										transition:name={index === 0 ? `property-image-${id}` : undefined}
									/>
								</a>
							)
						})
					}
				</div>
				<button
					class="absolute bottom-4 right-4 flex items-center gap-2 rounded-lg border border-airbnb-gray-500 bg-white px-4 py-2 text-sm font-medium text-airbnb-gray-500 transition-colors hover:bg-airbnb-gray-50"
				>
					<svg
						xmlns="http://www.w3.org/2000/svg"
						viewBox="0 0 24 24"
						fill="none"
						stroke="currentColor"
						stroke-width="2"
						stroke-linecap="round"
						stroke-linejoin="round"
						class="size-4"
					>
						<rect width="7" height="7" x="3" y="3" rx="1"></rect><rect
							width="7"
							height="7"
							x="14"
							y="3"
							rx="1"></rect><rect width="7" height="7" x="14" y="14" rx="1"></rect><rect
							width="7"
							height="7"
							x="3"
							y="14"
							rx="1"></rect>
					</svg>
					Mostrar todas las fotos
				</button>
			</div>
		</section>

		<div class="grid grid-cols-1 gap-12 lg:grid-cols-3 lg:gap-16">
			<div class="lg:col-span-2">
				<div class="flex items-start justify-between border-b border-airbnb-gray-200 pb-6">
					<div>
						<h2 class="text-xl font-semibold text-airbnb-gray-500">Propiedad en Argentina</h2>
						<div class="mt-1 flex flex-wrap items-center gap-2 text-airbnb-gray-400">
							{property?.rooms && <span>{property.rooms} habitaciones</span>}
							{property?.rooms && property?.m2 && <span>·</span>}
							{property?.m2 && <span>{property.m2} m²</span>}
						</div>
					</div>
				</div>

				<article class="border-b border-airbnb-gray-200 py-8">
					<h3 class="mb-4 text-xl font-semibold text-airbnb-gray-500">Acerca de esta propiedad</h3>
					<p class="whitespace-pre-line leading-relaxed text-airbnb-gray-400">
						{property?.description || "No hay descripcion disponible para esta propiedad."}
					</p>
				</article>

				<section class="py-8">
					<h3 class="mb-4 text-xl font-semibold text-airbnb-gray-500">Ubicacion</h3>
					<Map location={property?.localization} client:load />
				</section>
			</div>

			<div class="lg:col-span-1">
				<div class="sticky top-[140px] rounded-xl border border-airbnb-gray-200 p-6 shadow-airbnb">
					<div class="mb-6 flex items-baseline gap-1">
						<span class="text-2xl font-semibold text-airbnb-gray-500">{formattedPrice}</span>
						{property?.price && <span class="text-airbnb-gray-400">USD</span>}
					</div>

					<div class="mb-4 space-y-4">
						<div class="overflow-hidden rounded-xl border border-airbnb-gray-200">
							<div class="grid grid-cols-2 divide-x divide-airbnb-gray-200">
								<div class="p-3">
									<label
										class="block text-[10px] font-semibold uppercase tracking-wide text-airbnb-gray-500"
										>Tipo</label
									>
									<span class="text-sm text-airbnb-gray-400">{property?.type || "Venta"}</span>
								</div>
								<div class="p-3">
									<label
										class="block text-[10px] font-semibold uppercase tracking-wide text-airbnb-gray-500"
										>M2</label
									>
									<span class="text-sm text-airbnb-gray-400">{property?.m2 || "-"} m²</span>
								</div>
							</div>
						</div>
					</div>

					<a
						href={`https://wa.me/15566778899?text=Hola! Me interesa la propiedad: ${property?.title}`}
						target="_blank"
						rel="noopener noreferrer"
						class="airbnb-btn-primary mb-3 block w-full text-center"
					>
						Consultar por WhatsApp
					</a>

					<button class="airbnb-btn-secondary w-full"> Agendar visita </button>

					<p class="mt-4 text-center text-xs text-airbnb-gray-300">
						No se realizan cargos en esta etapa
					</p>
				</div>
			</div>
		</div>
	</section>

	<script>
		import PhotoSwipeLightbox from "photoswipe/lightbox"

		const lightbox = new PhotoSwipeLightbox({
			gallery: "#gallery",
			children: "a",
			pswpModule: () => import("photoswipe"),
		})

		lightbox.init()
	</script>
</Layout>
